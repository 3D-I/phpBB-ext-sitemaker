!function(t,e,n,i){"use strict";var a="",o=!1,l=!1,s=!1,r={},c={},d={},u={},f={},p={},g={},h={},b={},v={},m={},k={},y={},x={},C={},w={},z={},U={},j=function(t){var e=t.length,n=t.parent().data("columns")!==i?t.parent().data("columns")<=5?t.parent().data("columns"):5:3,a=e%n,o=e-a;if(n>=e)n=e;else if(t.parent().hasClass("equal")){if(a>0&&n>3)for(var l=1;a>l;l++)if(e%(n-l)===0){n-=l;break}o=e,a=0}t.removeClass("unit size1of1 size1of2 size1of3 size1of4 size1of5 lastUnit").parent().children(".clear").remove(),o>0&&t.slice(0,o).addClass("unit size1of"+n).filter(":nth-child("+n+"n)").addClass("lastUnit").after('<div class="clear"></div>'),a&&t.slice(o,e).addClass("unit size1of"+a).last().addClass("lastUnit")},D=function(){r.addClass("show-positions"),c.removeClass("lastUnit"),d.removeClass("empty-position")},S=function(){r.removeClass("show-positions"),d=t('.block-position:not(:has(".block"))').addClass("empty-position"),u.find(".block").size()||c.addClass("lastUnit")},_=function(e,n,i){t(i).removeAttr("role aria-disabled data-block class style").addClass("block").html('<div class="ui-state-highlight cms-block-spacing sorting" style="padding: 5px"><i class="fa fa-spinner fa-2x fa-spin"></i> '+lang.ajaxLoading+"</div>"),t.getJSON(ajaxUrl+"add",{block:t.trim(n),weight:i.parent().find(".block").index(i),route:route,ext:ext,position:e},function(e){if(l=!1,""===e.id)return void t(i).remove();var n=f.render(e);t(i).attr("id","block-"+e.id).html(n).children().not(".block-controls").show("scale",{percent:100},1e3),W(),F()})},O=function(e){t.getJSON(ajaxUrl+"edit",{id:e.attr("id").substring(6)},function(e){w=e,e.form&&(b.html(e.form),b.find("#block-settings").tabs(),b.find("select[data-togglable-settings]").each(function(){var e=t(this);e.change(function(){phpbb.toggleSelectSettings(e)}),phpbb.toggleSelectSettings(e)}),b.dialog({buttons:y}).dialog("option","title",lang.edit+" - "+e.title).dialog("open"))})},T=function(e){var n=t("#edit_form"),i=b.dialog("widget").find("#update-similar:checked").length;t.getJSON(ajaxUrl+"save?route="+route+"&id="+e.attr("id").substring(6)+"&similar="+i+"&"+n.serialize(),function(e){b.dialog("close"),t.each(e,function(e,n){t("#block-"+n.id).html(f.render(n))})})},A=function(e){return e.id===i?!1:void t.post(ajaxUrl+"update?route="+route,e,function(t){o===!0&&q(t.title)},"json")},J=function(e){e.id!==i&&t.getJSON(ajaxUrl+"custom",e,function(t){"function"==typeof phpbb.ajaxCallbacks[t.callback]&&phpbb.ajaxCallbacks[t.callback].call(i,t)})},N=function(e){t.post(ajaxUrl+"set_default?route="+(e===!0?route:""))},M=function(e){t.post(ajaxUrl+"set_startpage",t.param(e))},P=function(e){t.post(ajaxUrl+"layout_settings?route="+route+"&ext="+ext,e.serialize())},B=function(e){var n=t(".block-position");t.getJSON(ajaxUrl+"copy_layout?route="+route+"&ext="+ext+"&"+t.param(e),function(e){0!==e.data.length&&(D(),n.empty(),t.each(e.data,function(e,n){var i=t("#pos-"+e);t.each(n,function(t,e){var n=f.render(e);i.append('<div id="block-'+e.id+'" class="unit size1of1 block"></div>'),i.find("#block-"+e.id).html(n)}),i.hasClass("horizontal")&&j(i.find(".block"))}),S())})},E=function(){var e=[];t(".block-position").each(function(){var n=0,a=t(this).attr("id");t(this).find(".block").each(function(o,l){var s=t(l).attr("id");a!==i&&s!==i&&(e.push({bid:s.substring(6),position:a.substring(4),weight:n}),n++)})}),t.post(ajaxUrl+"save_layout",{route:route,blocks:e},function(){U.button("disable"),l=!1})},Q=function(t){return o===!0?void g.children(":input").trigger("blur"):(o=!0,a=t.removeClass("block-title").text(),void g.show().appendTo(t.text("")).children(":input").val(a).focus().select().end())},q=function(e){var n=g.parent();o=!1,a="",n.addClass("block-title").text(e),g.hide().appendTo(t("body"))},I=function(e){if(o!==!1){var n=t(e).parentsUntil(".block").parent().attr("id").substring("6"),i=t(e).val();return n&&i!==a?A({id:n,field:"title",title:i}):q(a),!1}},L=function(){var e=jQuery.extend(!0,{},w),n=b.find("#edit_form").serializeArray();t.each(n,function(){e[this.name]=this.value}),C.html(f.render(e))},V=function(){C.html(f.render(w))},W=function(){t(".block-icon").iconPicker({onSelect:function(t,e,n){var i=t.parentsUntil(".block").parent().attr("id").substring("6");A({id:i,icon:n})}})},F=function(){tinymce.init({selector:"div.editable-block",inline:!0,plugins:["advlist autolink lists link image charmap print preview anchor","searchreplace visualblocks code fullscreen","insertdatetime media table contextmenu paste"],valid_elements:"*[*]",toolbar:"insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image",setup:function(e){var n="",i="";e.on("blur",function(){var a=e.getContent({format:"raw"});if(e.getContent().length>0){var o=t("#"+e.id).data("raw",a).data();a!==i&&a!==lang.placeholder?(o.id=e.id.substring(13),o.content=a,J(o)):e.setContent(n)}else e.setContent(n?n:lang.placeholder)}),e.on("init",function(){0===e.getContent().length&&e.setContent(lang.placeholder)}),e.on("focus",function(){i=t("#"+e.id).data("raw"),n=e.getContent({format:"raw"}),e.setContent(i)})}})},G=function(t){t&&(z.html(t),z.fadeIn().delay(3e3).fadeOut())},H=function(t,e){t?G('<span><i class="fa fa-info-circle fa-blue fa-lg"></i> '+lang.hidingBlocks+"</span>"):e.length&&G('<span><i class="fa fa-info-circle fa-blue fa-lg"></i> '+lang.hidingPos+": <strong>"+e.join(", ")+"</strong></span>")};t(n).ready(function(){var n="",a={},o={},w=!1,A=t("#admin-bar").delay(300).slideDown().find("#admin-control").click(function(){return typeof editMode!==i&&editMode?(t(this).prev().toggle(),!1):void 0}).find("i");if(typeof editMode!==i&&editMode){g=t('<form class="inline-form"><input type="text" class="inline-edit" value="" /></form>').hide().appendTo(t("body")),t("#add-block-panel").find(".primetime-block").draggable({scroll:!0,revert:!0,addClasses:!1,opacity:.7,helper:"clone",connectToSortable:".block-position",start:function(){D()},stop:function(){e.setTimeout(function(){l===!1&&S()},1e3)}}),o=t("#ex_positions"),r=t(".block-position").addClass("block-receiver").sortable({revert:!0,placeholder:"ui-state-highlight cms-block-spacing sorting",forcePlaceholderSize:!0,items:".block",cancel:".editable-block, .inline-edit",delay:150,dropOnEmpty:!0,tolerance:"pointer",connectWith:".block-position",cursorAt:{left:5},start:function(e,n){p=t(n.item).addClass("dragging").parent(".horizontal"),D(),r.sortable("refresh")},update:function(e,n){if(l=!0,t(n.item).attr("id")===i){var o=t(this).attr("id").substring("4"),s=t(n.item).attr("data-block"),r=t(this).find('div[data-block="'+s+'"]');a.trigger("click"),_(o,s,r)}else U.button("enable");var c=t(n.item).removeAttr("style").parent(".horizontal").find(".block");t(n.item).removeClass("unit size1of1 size1of2 size1of3 size1of4 size1of5 lastUnit").parent().removeClass("empty-position"),c.length>0&&j(c),p.attr("id")!==t(n.item).parent(".horizontal").attr("id")&&j(p.find(".block"))},stop:function(e,n){t(n.item).removeClass("dragging"),S(),t("body").trigger("layoutChanged")}}).on("click",".block-title",function(){Q(t(this))}).on("submit",".inline-form",function(e){e.preventDefault(),t(this).find(".inline-edit").trigger("blur")}).on("focusout",".inline-edit",function(){I(t(this))}).on("click",".edit-block",function(e){e.preventDefault(),C=t(this).parentsUntil(".block").parent(),O(C)}).on("click",".delete-block",function(e){e.preventDefault(),C=t(this).parentsUntil(".block").parent(),h.dialog({buttons:k}).dialog("open")}).each(function(e,n){var i=t(n).attr("id").substring("4");0===o.find("option[value="+i+"]").length&&o.append('<option value="'+i+'">'+i+"</option>")}),phpbb.addAjaxCallback("previewCustomBlock",function(e){t("#block-editor-"+e.id).html(e.content.replace("./../../",""))}),U=t("#toggle-edit").button().click(function(){}).parent().next().children("a").button({disabled:!0}).click(function(t){t.preventDefault(),E()}),t(".has_dropdown").click(function(e){e.preventDefault(),t(this).parentsUntil("ul").parent().find(".dropped").not(t(this)).removeClass("dropped").next().hide(),a=t(this).toggleClass("dropped"),a.next().toggle()}).next().mouseleave(function(){}),t("#admin-options").show(100,function(){var e=t.grep(o.val(),function(t){return t.length});H(w,e)}),z=t("#ajax-message"),c=t("#main-content"),u=t("#pos-subcontent"),d=t('.block-position:not(:has(".block"))').addClass("empty-position"),f=twig({data:t.trim(t("#block-template-container").html())}),t.ajaxSetup({beforeSend:function(t,e){A.addClass("fa-spinner fa-green fa-spin fa-lg fa-pulse"),e.url+=(e.url.indexOf("?")<0?"?":"&")+"style="+style},complete:function(){A.delay(1e3).removeClass("fa-spinner fa-green fa-spin fa-lg fa-pulse")},success:function(e){var n=e.message?e.message:e.errors;n&&(t("#loading").hide(),G(n))},error:function(t){t.preventDefault(),G(lang.ajaxError)}}),y[lang.edit]=function(){T(C)},y[lang.cancel]=function(){V(),t(this).dialog("close")},k[lang.remove]=function(){var e=C.parent(".horizontal");C.hide("scale",{percent:5},3e3).parent().remove();var n=e.find(".block");n.length>0&&j(n),S(),U.button("enable"),t(this).dialog("close")},k[lang.cancel]=function(){t(this).dialog("close")};var J={autoOpen:!1,modal:!0,width:"auto",show:"slide",hide:"slide"};h=t("#dialog-confirm").dialog(J),x[lang.deleteAll]=function(){t(this).dialog("close"),t(".block-position").empty(),S(),U.button("enable"),l=!0},x[lang.cancel]=function(){t(this).dialog("close")};var q=t("#dialog-delete-all").dialog(J),K=t("#delete-blocks").button().click(function(t){t.preventDefault(),q.dialog({buttons:x}).dialog("open")});m[lang.copy]=function(){t(this).dialog("close"),B(n),K.parent().show()},m[lang.cancel]=function(){t(this).dialog("close")},v=t("#dialog-copy").dialog(J),t("#copy-form").find(".layout-action").button().click(function(e){e.preventDefault(),n=t(this).parent().parent().serializeArray();var i=n[0].value,o=n[1].value,l=t(this).data("action");if(""===i||i===route&&o===style)return!1;if("copy"===l)a.trigger("click"),v.dialog({buttons:m}).dialog("open");else{var s="";s+=("/"===i.substring(0,1)?appUrl:boardUrl+"/")+i,s+=(s.indexOf("?")>=0?"&":"?")+"style="+o+"&edit_mode=1",location.href=s}}),J.open=function(){if(s===!1){var e=t(this).dialog("widget").find(".ui-dialog-buttonpane");s=!0,t('<label class="dialog-check-button"><input id="update-similar" type="checkbox" checked="checked" />'+lang.updateSimilar+"</label>").prependTo(e)}},b=t("#dialog-edit").dialog(J).on("click",".block-class-actions",function(e){switch(e.preventDefault(),t(this).data("action")){case"clear":b.find("#block_class").val("").change(),e.preventDefault();break;case"toggle":b.find("#css-class-options").slideToggle(),e.preventDefault()}}).on("click",".class-cat",function(e){var n=t(this).attr("href"),i=t("#classes-scroller");i.animate({scrollTop:i.scrollTop()+t(n).position().top-200},1e3),e.preventDefault()}).on("click",".transform",function(e){var n=b.find("#block_class"),i=n.val();i=(i?i+" ":"")+t(this).text(),n.val(i).change(),e.preventDefault()}).on("change",".block-preview",function(){L()}),t(".default-layout").button().click(function(e){var n=t(this).data("set");N(n),e.preventDefault(),n===!0?(t(this).parent().hide().next().hide().next().show(),K.parent().hide()):(t(this).parent().hide().prev().hide().prev().show(),K.parent().show())}),t(".pt-startpage").button().click(function(e){e.preventDefault();var n={};"set-startpage"===t(this).attr("id")?(t(this).parent().hide().next().show(),n={controller:t(this).data("controller"),method:t(this).data("method"),params:t(this).data("params")},M(n)):(t(this).parent().hide().prev().show(),M(n))}),w=t("#route-settings").submit(function(e){P(t(this)),e.preventDefault()}).find("#hide_blocks").is(":checked"),e.onbeforeunload=function(t){return l===!0?(t=t||e.event,t&&(t.returnValue=lang.leaveConfirm),lang.leaveConfirm):void 0},W(),F()}})}(jQuery,window,document);