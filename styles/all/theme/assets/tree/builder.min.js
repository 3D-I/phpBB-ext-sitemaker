!function(t,e,i,s){"use strict";var n=e.lang||{},o=e.twig||{};t.widget("sitemaker.treeBuilder",{options:{ajaxUrl:"",loadSpeed:10,primaryKey:"item_id",listType:"ol",noNesting:".no-nest",nestedList:"#sortable",editForm:"#edit-form",noItems:"#no-items",addBtn:"#add-new",addBulkBtn:"#add-bulk",saveBtn:"#save",deleteSelBtn:"#delete-selected",rebuildBtn:"#rebuild-tree",selectAll:"#select-all",loading:"#loading",ajaxMessage:"#ajax-message",itemTemplate:"#item-template",actionClass:".item-action",selectItemClass:".select-item",iconSelectClass:".icon-select",dialogEdit:"#dialog-edit",dialogConfirm:"#dialog-confirm",loaded:function(){},updated:function(){}},_create:function(){var e=this,s={},d={},a={};this.nestedList=this.element.addClass("tree-builder").find(this.options.nestedList).nestedSortable({disableNesting:this.options.noNesting,forcePlaceholderSize:!0,listType:this.options.listType,handle:"div",helper:"clone",items:"li",opacity:.6,placeholder:"placeholder",tabSize:25,tolerance:"pointer",toleranceElement:"> div",errorClass:this.options.ajaxMessage,update:function(){e.itemsChanged=!0,e.saveBtn.button("option","disabled")&&e.saveBtn.button("option","disabled",!1)}}),d[n.deleteChildNodes]=function(){t("li#item-"+e.itemID).remove(),t(this).dialog("close"),e._saveTree()},d[n.deleteNode]=function(){var i=t("#item-"+e.itemID);i.children(e.options.listType).length&&i.parent(e.options.listType).parent("li").append("<"+e.options.listType+">"+i.children(e.options.listType).html()+"</"+e.options.listType+">"),i.remove(),t(this).dialog("close"),e._saveTree()},d[n.cancel]=function(){t(this).dialog("close")},s[n.editNode]=function(){e._checkRequired()&&(e.itemID&&e._updateItem(e.itemID),t(this).dialog("close"))},s[n.cancel]=function(){t(e.dialogID).dialog("close")},a[n.deleteNode]=function(){e.element.find(e.options.selectItemClass+":checked").parentsUntil("li").parent().remove(),e._saveTree(),t(this).dialog("close"),0===e.nestedList.find("li").length&&e._resetActions()},a[n.cancel]=function(){t(this).dialog("close")};var l={autoOpen:!1,modal:!0,width:"auto",show:"slide",hide:"slide"};t(this.options.dialogEdit).dialog(l),t(this.options.dialogConfirm).dialog(l),this.msgObj=this.element.find(this.options.ajaxMessage).ajaxError(function(){return e.showMessage(n.errorMessage),!1});var r=this.element.find(this.options.loading);t(i).ajaxStart(function(){r.fadeIn()}).ajaxStop(function(){r.fadeOut()}),this.selectAllObj=this.element.find(this.options.selectAll).click(function(){e.nestedList.find(e.options.selectItemClass).prop("checked",this.checked),e.deleteSelBtn.button(this.checked?"enable":"disable")});var h={};h["click"+this.options.selectItemClass]=function(){var t=this.element.find(this.options.selectItemClass+":checked").length;this.deleteSelBtn.button(t>0?"enable":"disable"),t===this.element.find(this.options.selectItemClass).length?this.selectAllObj.prop("checked",!0):this.selectAllObj.prop("checked",!1)},h["click.editable"]=function(e){this._makeEditable(t(e.target))},h["blur#inline-edit"]=function(e){this._processEditable(t(e.target))},h["submit#inline-form"]=function(e){e.preventDefault(),t(e.target).find("#inline-edit").trigger("blur")},h["click"+this.options.actionClass]=function(i){var o=t(i.currentTarget).data("action");switch(this.itemID=e._getItemId(t(i.currentTarget)),o){case"edit":this.dialogID=this.options.dialogEdit,this._populateForm(this.itemID),t(this.dialogID).dialog({buttons:s}).dialog("option","title",n.editNode).dialog("open");break;case"delete":var a=t.extend({},d);this.dialogID=this.options.dialogConfirm,t("#item-"+this.itemID).children(this.options.listType).children("li").length<1&&delete a[n.deleteChildNodes],t(this.dialogID).dialog({buttons:a}).dialog("open");break;case"show":case"hide":var l="show"===o?1:0;e._saveItem("update_item",{item_status:l,field:"item_status"},this.itemID)}},this._on(this.document,h),this.addBtn=this.element.find(this.options.addBtn).button({icons:{primary:"ui-icon-plus"}}).click(function(){return e.addItem(),!1}),this.addBulkBtn=this.element.find(this.options.addBulkBtn).button({text:!1,icons:{primary:"ui-icon-triangle-1-s"}}).click(function(i){var s=t(i.target).offset(),o=t(i.target).height(),d=t(i.currentTarget).toggleClass("dropped").blur().parent().next().slideToggle().offset({top:s.top+o+5,left:s.left-167});if(t(i.currentTarget).hasClass("dropped")===!0){var a='<option value="0">'+n.none+"</option>";d.find("select").html(e._getOptions(e.nestedList,"",a)).next().val()}return!1}),this.addBulkBtn.parent().buttonset().show().next().hide().find("#cancel").click(function(){e.addBulkBtn.trigger("click")}).next().click(function(i){var s=t(i.target).parentsUntil("form").parent(),n={add_list:s.find("#add_list").val(),parent_id:s.find("#parent_id").val()};e._addBulk(t.param(n)),e.addBulkBtn.trigger("click"),s.find("textarea").val(""),i.preventDefault()}),this.rebuildBtn=this.element.find(this.options.rebuildBtn).button({disabled:!0,icons:{primary:"ui-icon-refresh"}}).click(function(){return e.rebuildTree(),!1}),this.deleteSelBtn=this.element.find(this.options.deleteSelBtn).button({disabled:!0,icons:{primary:"ui-icon-trash"}}).click(function(){return e.dialogID=e.options.dialogConfirm,t(e.dialogID).dialog({buttons:a}).dialog("open"),!1}),this.saveBtn=this.element.find(this.options.saveBtn).button({disabled:!0,icons:{primary:"ui-icon-check"}}).click(function(){return e.itemsChanged===!0&&e._saveTree(),!1}),this.addBtnOffset=this.addBtn.offset(),this.noItems=this.element.find(this.options.noItems),this.editForm=t(this.options.editForm),o({id:"item_template",data:this.element.find(this.options.itemTemplate).html()}),this.getItems()},addItem:function(){this._saveItem("add_item",{})},updateItem:function(t,e){this._saveItem("update_item",t,e)},getItems:function(){var e=this;t.getJSON(this.options.ajaxUrl+"load_items",function(t){e.nestedList.empty(),e._resetActions(),t.items!==s&&t.items.length>0&&(e._showActions(),e._addToTree(t.items))})},rebuildTree:function(){var e=this;this.nestedList.empty(),this._resetActions(),t.getJSON(this.options.ajaxUrl+"rebuild_tree",function(t){e._showActions(),e._addToTree(t.items)})},showMessage:function(t){t&&(this.msgObj.text(t),this.msgObj.fadeIn().delay(3e3).fadeOut())},_addBulk:function(e){var i=this;t.post(this.options.ajaxUrl+"add_bulk",e,function(t){t.error?i.showMessage(t.error):(i._showActions(),i._addToTree(t.items))},"json")},_addToTree:function(e,i){if(e.length>0){var o={},d=e.shift();if(d.item_title=d.item_title?d.item_title:n.changeMe,d.parent_id>0){var a=t("#item-"+d.parent_id),l=a.children(this.options.listType);0===l.length?(o=t("<"+this.options.listType+">"+this._renderItem(d)+"</"+this.options.listType+">").hide(),o.appendTo(a)):(o=t(this._renderItem(d)).hide(),o.appendTo(a.children(this.options.listType)))}else o=t(this._renderItem(d)).hide(),o.appendTo(this.nestedList);var r=this;o.effect("slide",{direction:"right",mode:"show"},this.options.loadSpeed,function(){r._addToTree(e,i)})}i!==s&&i.apply(this,[e]),this._trigger("loaded",null,{items:e})},_checkRequired:function(){t(this.dialogID+" .error").remove();var e=!0;return t(this.dialogID+" .required").each(function(){t(this).val()||(t('<div class="error">'+n.required+"</div>").insertAfter(this),e=!1)}),e},_getItemId:function(t){return t.attr("id").substring("5")},_getOptions:function(e,i,s){var n=this;return e.children("li").each(function(e,o){var d=t(o),a=d.attr("id").substr("5"),l=i+"&#x251c;&#x2500; "+d.find(".editable:first").text(),r='<option value="'+a+'">'+l+"</option>";s+=n._getOptions(d.children("ol"),"&nbsp;&nbsp;&nbsp;&nbsp;"+i,r)}),s},_makeEditable:function(e){return this.editing===!0?void this.editor.trigger("blur"):(this.editing=!0,this.editorVal=e.text()!==n.changeMe?e.text():"",e.replaceWith('<form id="inline-form"><input type="text" id="inline-edit" value="'+this.editorVal+'" /></form>'),void(this.editor=t("#inline-edit").data("field",e.data("field")).focus().select()))},_populateForm:function(e){var i=this;return t.get(this.options.ajaxUrl+"load_item?item_id="+e,function(t){i.showMessage(t.message),i.editForm.populate(t)},"json"),{}},_processEditable:function(e){if(this.editing!==!1){var i=this._getItemId(t(e).parentsUntil("li").parent()),s=t(e).data("field"),o=t(e).val(),d={};return i&&s&&o&&o!==this.editorVal?(d[s]=o,d.field=s,this._saveItem("update_item",d,i,s)):this._undoEditable(this.editorVal?this.editorVal:n.changeMe),!1}},_resetActions:function(){this.noItems.show(),this.nestedList.hide(),this.addBulkBtn.parent().next().slideUp(),this.selectAllObj.prop("checked",!1).parent().hide(),this.deleteSelBtn.button("disable").hide(),this.rebuildBtn.button("disable").hide(),this.saveBtn.button("disable").hide()},_saveItem:function(e,i,s,n){var o=this;t.post(this.options.ajaxUrl+e+(s?"?item_id="+s:""),i,function(i){if(i.error)o.showMessage(i.error),o.editing&&o._undoEditable(o.editorVal);else switch(e){case"add_item":o._addToTree([i],function(){var e=t("#item-"+i[o.options.primaryKey]);o._showActions(),o._scrollTo(e,o.addBtnOffset.top,function(){e.find(".editable").trigger("click")})});break;case"update_item":o.editing?o._undoEditable(i[n]):o._refreshItem(i);break;case"save_item":var s=o._refreshItem(i);o._trigger("updated",null,s)}},"json")},_saveTree:function(){var t=this.nestedList.nestedSortable("toArray"),e=t.length;this._saveItem("save_tree",{tree:t}),this.itemsChanged=!1,this.saveBtn.button("option","disabled",!0),this.deleteSelBtn.button("option","disabled",!0),e>0?this.noItems.hide():this.noItems.show()},_scrollTo:function(t,e,i){var s=t.offset(),n=s.top,o=n-e;this.nestedList.animate({scrollTop:o},1e3,i)},_showActions:function(){this.noItems.hide(),this.nestedList.show(),this.selectAllObj.parent().show(),this.deleteSelBtn.show(),this.saveBtn.show(),this.rebuildBtn.button("enable").show()},_renderItem:function(t){return o({ref:"item_template"}).render(t)},_refreshItem:function(e){var i=t(this._renderItem(e)).children();return t("#item-"+e[this.options.primaryKey]).children(":first").replaceWith(i)},_undoEditable:function(t){this.editorVal="",this.editing=!1,this.editor.parent().replaceWith('<span class="editable" data-field="'+this.editor.data("field")+'">'+t+"</span>")},_updateItem:function(t){this._saveItem("save_item",this.editForm.serializeArray(),t)}})}(jQuery,window,document);
//# sourceMappingURL=../../../../all/theme/assets/tree/builder.min.js.map